---
title: "MORSE tutorial for 'gm' models"
date: "`r Sys.Date()`"
output:
  html_vignette:
    toc: true
self_contained: no
vignette: >
  %\VignetteIndexEntry{Tutorial_gm}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


```{r options,include=FALSE, echo=FALSE}

knitr::opts_chunk$set(fig.width = 7,
                      fig.height = 4,
                      cache = TRUE)

```



```{r, echo=FALSE, cache=TRUE, results='hide'}
library(morse)
library(stringr)
library(dplyr)
library(tidyr)
library(rjags)
library(coda)
library(zoo)
library(gridExtra)
library(reshape2)
library(epitools)
library(ggplot2)
```

# Survival data analysis using TKTD model GUTS with time exposure variable concentration

Data set : Diazinon and *Pimephales promelas*.
This data set is taken from the fathead minnow toxicity database[Geiger1988]. It represents a typical fish acute
toxicity study, and it includes a hypothetical exposure profile representing a typical FOCUS-SW ditch and a real exposure profile from chemical monitoring in a stream [Wittmer2010, Ashauer2011].


## Step 1: check the structure and the dataset integrity and create a `survData` object

```{r diazinon data, include=FALSE, echo=FALSE}
data(gm_diazinonPimephales_Nsurv)
data(gm_diazinonPimephales_conc)
```

```{r step 1, cache=TRUE}
df_Nsurv = gm_diazinonPimephales_Nsurv %>%
  filter(varType == "var") %>%
  select(-varType)
df_conc = gm_diazinonPimephales_conc %>%
   filter(varType == "var") %>%
   select(-varType)

# Check the structure and the dataset integrity 
gm_survDataCheck(data_surv = df_Nsurv,
                 data_conc = df_conc)

# Check the structure and the dataset integrity 
gm_dat = gm_survData(data_surv = df_Nsurv,
                  data_conc = df_conc)

head(gm_dat)
```


## Step 2: visualize your dataset

The function `plot` can be used to plot the number of surviving individuals
as a function of time for all profiles.

```{r step 2, cache=TRUE}
plot(gm_dat)

plot(gm_dat,
     facetting.level = c("varControl","varA","varB","varC"))

plot(gm_dat,
     facetting = FALSE)

```

The function `summary` provides some descriptive statistics on the experimental design.

```{r, cache=TRUE}
summary(gm_dat)
```


## Step 3: fit an exposure-response model to the survival data at target time

```{r, cache=TRUE}
fit <- gm_survFitTKTD(gm_dat, model_type = "IT")


fit <- survFitTT(dat,
                 target.time = 21,
                 lcx = c(10, 20, 30, 40, 50))
``` 

DEBUG 

```{r}
data = gm_dat
model_type = "IT"
nbr.chain = 3
nbr.adapt = 1000

#== 

### time start
  time_start <- Sys.time()

  ### class of object
  if(!is(data, "gm_survData")){
    stop("gm_survFitTKTD: object of class 'gm_modelData' expected")
  }

  ### ensures model_type is one of "SD" and "IT"
  if(is.null(model_type)) {
    stop("You need to specify a 'model_type': 'SD' or 'IT'")
  }
  if(!model_type %in% c("SD","IT")) {
    stop("'model_type' available for use are 'SD' or 'IT'")
  }

  ### check number of sample for the diagnostic procedure
  if (nbr.chain < 2) {
    stop('2 or more parallel chains required')
  }

  ##
  ## Data and Priors for model
  ##

  globalData = gm_modelData(data,
                            model_type = model_type)

  modelData = globalData$modelData
  modelData_Null = globalData$modelData_Null
  priorsData = globalData$priorsMinMax

  ##
  ## Define model
  ##

  cst_conc <- globalData$cst_conc

  if(model_type == "SD"){
    ### Determine sampling parameters
    parameters <- c("kd_log10", "hb_log10", "kk_log10", "z_log10")

    if(cst_conc){
      file_to_use <- jags_TKTD_cstSD
    } else{
      file_to_use <- jags_TKTD_varSD
    }
  } else if(model_type == "IT"){
    ### Determine sampling parameters
    parameters <- c("kd_log10", "hb_log10","alpha_log10", "beta_log10")

    if(cst_conc){
      file_to_use <- jags_TKTD_cstIT
    } else{
      file_to_use <- jags_TKTD_varIT
    }
  }
  
  model_Null <- survLoadModel(model.program = file_to_use,
                              data = modelData_Null,
                              n.chains = nbr.chain,
                              Nadapt = nbr.adapt,
                              quiet = TRUE)

  # model_Null <- jags.model(file = file_to_use,
  #                          data = modelData_Null,
  #                          inits,
  #                          n.chains = nbr.chain,
  #                          n.adapt = nbr.adapt,
  #                          quiet = TRUE)

  file_to_use <- jags_TKTD_varIT
  model <- survLoadModel(model.program = file_to_use,
                         data = modelData,
                         n.chains = nbr.chain,
                         Nadapt = nbr.adapt,
                         quiet = TRUE)

  # model <- jags.model(file = file_to_use,
  #                     data = modelData,
  #                     inits,
  #                     n.chains = nbr.chain,
  #                     n.adapt = nbr.adapt,
  #                     quiet = TRUE)



  ##
  ## estimate the number of iteration required for convergency of chains
  ## by using the raftery.diag
  ##

  if(is.null(nbr.warmup) | is.null(nbr.thin) | is.null(nbr.iter)){

    sampling.parameters <- modelSamplingParameters(model,
                                                   parameters,
                                                   n.chains)
    if (sampling.parameters$niter > 200000)
      stop("The model needs too many iterations to provide reliable parameter estimates !")

    nbr.warmup = sampling.parameters$burnin
    nbr.thin = sampling.parameters$thin
    nbr.iter = sampling.parameters$niter

  }

  ### Null model to check priors with the model
  update(model_Null, nbr.warmup)
  mcmc_Null =  coda.samples(model_Null,
                            variable.names = parameters,
                            n.iter = nbr.iter,
                            thin = nbr.thin,
                            quiet = TRUE)

  ### model to check priors with the model
  update(model, nbr.warmup)
  mcmc =  coda.samples(model,
                       variable.names = parameters,
                       n.iter = nbr.iter,
                       thin = nbr.thin)

  ##
  ## Cheking posterior range with data from experimental design:
  ##

  estim.par <- gm_survTKTDPARAMS(mcmc, model_type = model_type)

  if (estim.par["kk", "Q97.5"] > priorsData$kk_max)
    warning("The estimation of the killing rate (model parameter k) lies outside the range used to define its prior distribution which indicates that this rate is very high and difficult to estimate from this experiment !",
            call. = FALSE)

  if (estim.par["kd", "Q97.5"] > priorsData$kd_max)
    warning("The estimation of the dominant rate constant (model parameter kd) lies outside the range used to define its prior distribution which indicates that this rate is very high and difficult to estimate from this experiment !",
            call. = FALSE)

  if (estim.par["hb", "Q2.5"] < priorsData$hb_min)
    warning("The estimation of the natural instantaneous mortality rate (model parameter hb) lies outside the range used to define its prior distribution which indicates that this rate is very low and so difficult to estimate from this experiment !",
            call. = FALSE)

  if (estim.par["z", "Q2.5"] < priorsData$z_min ||
      estim.par["z", "Q97.5"] > priorsData$z_max)
    warning("The estimation of Non Effect Concentration threshold (NEC) (model parameter z) lies outside the range of tested concentration and may be unreliable as the prior distribution on this parameter is defined from this range !",
            call. = FALSE)

  ### time end
  time_end = Sys.time() - time_start

  ##
  ## OUTPUT
  ##

  OUT <- list(mcmc = mcmc,
              mcmc_Null = mcmc_Null,
              data = gm_survData,
              estim.par = estim.par)

  class(OUT) <- "gm_survFitTKTD"

```



### Details on the step 3

```{r, cache=TRUE}
priors <- gm_priors(gm_dat, model_type = "IT") 
priors$priorsList
priors$priorsMinMax
```


```{r, cache=TRUE}
gm_datInterpol = gm_survData_interpolate(gm_dat, extend.time = 100)
gm_datInterpol

test_cst_conc(gm_dat)

modelData = gm_modelData(gm_dat, model_type = "IT")
modelData$modelData
```


# References

Geiger, D. L.; Call, D. J.; Brooke, L. T. Acute toxicities of organic chemicals to fathead minnow
(Pimephales promelas). Volume IV.; University of Wisconsin-Superior: Superior, Wisconsin, USA,
1988.

Wittmer, I. K.; Bader, H. P.; Scheidegger, R.; Singer, H.; LÃ¼ck, A.; Hanke, I.; Carlsson, C.;
Stamm, C., Significance of urban and agricultural land use for biocide and pesticide dynamics in
surface waters. Water Res. 2010, 44, (9), 2850-2862.

Ashauer, R.; Wittmer, I.; Stamm, C.; Escher, B. I., Environmental Risk Assessment of
Fluctuating Diazinon Concentrations in an Urban and Agricultural Catchment Using Toxicokinetic-
Toxicodynamic Modeling. Environ. Sci. Technol. 2011, 45, (22), 9783-9792.
