---
title: "MORSE tutorial for 'gm' models"
date: "`r Sys.Date()`"
output:
  html_vignette:
    toc: true
self_contained: no
vignette: >
  %\VignetteIndexEntry{Tutorial_gm}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


```{r options,include=FALSE, echo=FALSE}

knitr::opts_chunk$set(fig.width = 7,
                      fig.height = 4,
                      cache = TRUE)

```



```{r, echo=FALSE, cache=TRUE, results='hide'}
library(morse)
library(stringr)
library(dplyr)
library(tidyr)
library(rjags)
library(coda)
library(gridExtra)
library(reshape2)
library(epitools)
library(ggplot2)
```

# Survival data analysis using TKTD model GUTS with time exposure variable concentration

Data set : Diazinon and *Pimephales promelas*.
This data set is taken from the fathead minnow toxicity database[Geiger1988]. It represents a typical fish acute
toxicity study, and it includes a hypothetical exposure profile representing a typical FOCUS-SW ditch and a real exposure profile from chemical monitoring in a stream [Wittmer2010, Ashauer2011].


## Step 1: check the structure and the dataset integrity and create a `survData` object

```{r diazinon data, include=FALSE, echo=FALSE}
data(gm_diazinonPimephales_Nsurv)
data(gm_diazinonPimephales_conc)
```

```{r step 1, cache=TRUE}
df_Nsurv = gm_diazinonPimephales_Nsurv %>%
  filter(varType == "var") %>%
  select(-varType)
df_conc = gm_diazinonPimephales_conc %>%
   filter(varType == "var") %>%
   select(-varType)

# Check the structure and the dataset integrity 
gm_survDataCheck(data_surv = df_Nsurv,
                 data_conc = df_conc)

# Check the structure and the dataset integrity 
gm_dat = gm_survData(data_surv = df_Nsurv,
                  data_conc = df_conc)

head(gm_dat)
```


## Step 2: visualize your dataset

The function `plot` can be used to plot the number of surviving individuals
as a function of time for all profiles.

```{r step 2, cache=TRUE}
plot(gm_dat)

plot(gm_dat,
     facetting = FALSE)

plot(gm_dat,
     facetting.level = c("varControl","varA","varB","varC"))

table(gm_dat[, c("profile", "time")])

```

The function `summary` provides some descriptive statistics on the experimental design.

```{r, cache=TRUE}
summary(gm_dat)
```


## Step 3: fit an exposure-response model to the survival data at target time


```{r, cache=TRUE}
priors <- gm_priors(gm_dat) 





fit <- gm_survFit(gm_dat, GUTS_type = "SD")


fit <- survFitTT(dat,
                 target.time = 21,
                 lcx = c(10, 20, 30, 40, 50))

```


# References

Geiger, D. L.; Call, D. J.; Brooke, L. T. Acute toxicities of organic chemicals to fathead minnow
(Pimephales promelas). Volume IV.; University of Wisconsin-Superior: Superior, Wisconsin, USA,
1988.

Wittmer, I. K.; Bader, H. P.; Scheidegger, R.; Singer, H.; LÃ¼ck, A.; Hanke, I.; Carlsson, C.;
Stamm, C., Significance of urban and agricultural land use for biocide and pesticide dynamics in
surface waters. Water Res. 2010, 44, (9), 2850-2862.

Ashauer, R.; Wittmer, I.; Stamm, C.; Escher, B. I., Environmental Risk Assessment of
Fluctuating Diazinon Concentrations in an Urban and Agricultural Catchment Using Toxicokinetic-
Toxicodynamic Modeling. Environ. Sci. Technol. 2011, 45, (22), 9783-9792.
